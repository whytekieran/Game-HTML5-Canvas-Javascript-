<!DOCTYPE html>

<html>
   <head>
    <meta charset="UTF-8">
    <title>Game</title>
    <!--CSS Styling-->
    <style type="text/css">
      body{
                background-color: black;
          }
    </style>
  </head>
    <!--Button tag with an onjeyup event for controlling your character-->
  <body onkeyup="whichButton(event)">
    
      <!--Creating a canvas-->   
    <canvas id="canvasOne" style="border: solid 5px red; width:100%; height:100%;"></canvas>
    
      <!--External Javascript Files-->
    <script type="text/javascript" src="BorderCollisionsPacman.js"></script><!--Handles border collisons for pacman-->
    <script type="text/javascript" src="Dot.js"></script>
    <script type="text/javascript" src="MouthMovePacman.js"></script>
    <script type="text/javascript" src="BouncingBall.js"></script>
    <script type="text/javascript" src="GameplayFunctions.js"></script>
    
    <!--JQuery and Plugin files for custom alert and confirm popup boxes with JQuery-->
    <script type="text/javascript" src="jquery-2.1.4.min.js"></script>
    <script src="JQuery-Alert-Dialogs/js/jquery.js" type="text/javascript"></script>
    <script src="JQuery-Alert-Dialogs/js/jquery.alerts.js" type="text/javascript"></script>
    
    <!--Link to css images for the popup boxes-->
    <link href="JQuery-Alert-Dialogs/css/jquery.alerts.css" rel="stylesheet" type="text/css" media="screen" />
      
    <!--Main Javascript file-->
    <script type="text/javascript">
        //Global Variables
        var canvas = document.getElementById("canvasOne"); 
        canvas.width = 1340;                                            //Setting width and height                            
        canvas.height = 620;
        var ctx = canvas.getContext("2d");  
        ctx.fillStyle = "black";                                        //Creating a black background outside of canvas border to                     ctx.fillRect(0, 0, canvas.width, canvas.height);
        var leftRight = 670;                                            //X co-ordinate for pacman character
        var upAndDownbody = 310;                                        //Y co-ordinate for pacman character
        var changeMouth = 0;                                            //counter for when pacmans mouth should open/close
        var radius = 50;                                                    //pacmans radius
        var dotRadius = 10;                                                 //dot pacman chases radius
        var ballRadius = 25;                                                //circle pacman avoids radius
        var openCloseMouth1 = 0.25;                                     //angles for pacmans mouth when going right
        var openCloseMouth2 = 1.75;
        var openCloseMouth3 = 1.25;                                     //angles for pacmans mouth when going left
        var openCloseMouth4 = 0.75;
        var openCloseMouth5 = 1.75;                                     //angles for pacmans mouth when going up
        var openCloseMouth6 = 1.25;
        var openCloseMouth7 = 0.25;                                     //angles for pacmans mouth when going down
        var openCloseMouth8 = 0.75;
        var mouthPositions = [];                                        //array to take the two return values of change mouth functions
        var speeds = [];
        var directions = [];                                            //keeps the changed directions (+ or -) for ball bouncing of canvas 
        var stopRight;                                                  //variables used to clear intervals
        var stopLeft;
        var stopUp;
        var stopDown;
        var xRandomDot = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;   //Random x/y for dot pacman chases  
        var yRandomDot = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
        var ballSpeedX = 0.5  //speed of ball chasing pacman
        var ballSpeedY = 0.5;
        var ballMaxSpeed = 30;                  //Maximum speed of the ball chasing pacman
        var scoreCnt = 0;                       //counter for the score
        var scoreIncrease = 1;                  //increase score
        var lives = 3;
        var caught = false;                     //Boolean to check if pacman has been hit by the ball
        var gotLife = false;                    //Boolean to check if pacman is entitled to a life
        var lifeDotLocationSet = false;         //Making sure the extra life location is set once and not at every animation frame
        var lifeDotX = 0;                       //X and Y coordinates for the extra life dot
        var lifeDotY = 0;
        var stillHitCnt = 0;                    //counter that runs while pacman is hit
        var changePacmanColour = -1;            //will be 0 or 1, decideds if we change pacmans colour
        var pacmanAudioOn = false;              //sets when pacman waka waka should be on/off
        var pacmanDeadEndAudio = false;         //condition to turn off audio when pacman dies
        var pacmanAudioResults = [];            //array to hold both the two booleans declared previous when returned from function
        var play = true;                        //Boolean which will be set to false when pacman dies to stop the animation frame running in                                                   //the background behind the cust JQuery plugin popup menu 
        
        //Creating audio objects
        var pacmanAudio = new Audio('AudioFiles/WakaWaka.mp3');
        var pacmanEatsAudio = new Audio('AudioFiles/PacmanGetsDot.mp3');
        var pacmanDiesAudio = new Audio('AudioFiles/PacmanDies.mp3');
        var pacmanIntroAudio = new Audio('AudioFiles/PacmanIntroMusic.mp3');
        var pacmanHurtAudio = new Audio('AudioFiles/HurtBeep.mp3');
        
        //Create and draw the dot object that pacman will chase, class define in Dot.js
        var dot = new Dot(xRandomDot, yRandomDot, dotRadius, ctx, "red");
        var dotExtraLife = new Dot(0, 0, 10, ctx, "yellow");
        dot.drawDot();                                                     //Calling drawDot class function 
        var bounceBall = new BouncingBall(0, 0, ballRadius, ctx, "blue");  //Ball object to catch pacman class defined in BouncingBall.js
        
        //Random x and y at startup for ball chasing pacman keep doing till correct (do/while)
        do
        {
             var xRandomBall = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;    
             var yRandomBall = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius;
        }
        while((xRandomBall <= ballRadius) || (xRandomBall >= 1315) || (yRandomBall <= ballRadius) || (yRandomBall >= 595));
        
        //Output the starting popup menu (defined in GameplayFunctions.js)
        startingInstructionsPopup();
        
        //call outputUserInfo() to output score and lives (defined in GameplayFunctions.js)
        outputUserInfo(ctx, scoreCnt, lives);
        
        //Play pacman starting game music pass the audio to the function
        pacmanBeginsAudio(pacmanIntroAudio);
   
        //Depending on which directional button is pressed call a directional function on pacman
        //turn off all other intervals and run only the direction specified.
        function whichButton(event) 
        {
            //Gets the key code
            var choice = event.keyCode;
             
            if(choice == 39)//Right
            { 
                //Clear up running animation frames and call the go right function
                window.cancelAnimationFrame(stopUp);            //To cancel an animation frame we call cancelAnimationFrame and
                window.cancelAnimationFrame(stopLeft);          //pass the id returned when the animation frame was created
                window.cancelAnimationFrame(stopDown);
                window.cancelAnimationFrame(stopRight);
                
                //Call startGameplayAudio() which controls when pacman waka waka is played. We pass the audio and two booleans
                //to control when it is played (defined in Gameplayfunctions.js)
                pacmanAudioResults = startGameplayAudio(pacmanAudioOn, pacmanDeadEndAudio, pacmanAudio);
                pacmanAudioOn = pacmanAudioResults[0];
                pacmanDeadEndAudio = pacmanAudioResults[1];
                pacmanGoRight(); //go right animation frame function
            }
            else if(choice == 37)//Left
            {
                //Clear up running animation frames and call the go left function
                window.cancelAnimationFrame(stopUp);
                window.cancelAnimationFrame(stopLeft);
                window.cancelAnimationFrame(stopDown);
                window.cancelAnimationFrame(stopRight);
                pacmanAudioResults = startGameplayAudio(pacmanAudioOn, pacmanDeadEndAudio, pacmanAudio);
                pacmanAudioOn = pacmanAudioResults[0];
                pacmanDeadEndAudio = pacmanAudioResults[1];
                pacmanGoLeft(); //go left animation frame function
            }
            else if(choice == 38)//Up
            {
                //Clear up running animation frames and call the go up function
                window.cancelAnimationFrame(stopUp);
                window.cancelAnimationFrame(stopLeft);
                window.cancelAnimationFrame(stopDown);
                window.cancelAnimationFrame(stopRight);
                pacmanAudioResults = startGameplayAudio(pacmanAudioOn, pacmanDeadEndAudio, pacmanAudio);
                pacmanAudioOn = pacmanAudioResults[0];
                pacmanDeadEndAudio = pacmanAudioResults[1];
                pacmanGoUp(); //go up animation frame function
            }
            else if(choice == 40)//Down
            {
                //Clear up running animation frames and call the go down function
                window.cancelAnimationFrame(stopUp);
                window.cancelAnimationFrame(stopLeft);
                window.cancelAnimationFrame(stopDown);
                window.cancelAnimationFrame(stopRight);
                pacmanAudioResults = startGameplayAudio(pacmanAudioOn, pacmanDeadEndAudio, pacmanAudio);
                pacmanAudioOn = pacmanAudioResults[0];
                pacmanDeadEndAudio = pacmanAudioResults[1];
                pacmanGoDown(); //go down animation frame fucntion
            }
        }
        
        //Make pacman go right
        function pacmanGoRight()
        {
            //Only if play is true do we run the animation frame
            if(play == true)
            {
                //Redraw canvas background (defined in GameplayFunctions.js)
                redrawCanvasBackground(ctx, canvas.height, canvas.width);
                
                //output the score and lives of user (defined in GameplayFunctions.js)
                outputUserInfo(ctx, scoreCnt, lives);
            
                dot.drawDot();// Draw/redraw random dot for pacman to chase
                
                //Move x/y of bouncing ball and then draw it (Defined in BouncingBall.js)
                bounceBall.moveBall(xRandomBall, yRandomBall);
                bounceBall.drawBall();
            
                //If we are allowed an extra life we set and draw the extra life dot dot/check for collisions on it
                if(gotLife == true)
                {
                    //move and draw the extra life dot, only draws if we are entitled to a life
                    //Set a new x/y co-ordinate for it and move it. (only if the location has not already been set)
                    if(lifeDotLocationSet == false)
                    {
                        //give dot a random position
                        lifeDotX = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;     
                        lifeDotY = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
                        dotExtraLife.moveDot(lifeDotX, lifeDotY)    //move the dot
                        lifeDotLocationSet = true;                  //its position has been set
                    }
                    dotExtraLife.drawDot();//draw the dot (defined in Dot.js)
                    
                    //If they(extra life dot / pacman) intersect give an extra life (intersect define in Dot.js)
                    if(dotExtraLife.intersect(leftRight, upAndDownbody, radius))
                    {
                        gotDotAudio(pacmanEatsAudio);//play the got dot audio, pass in the audio object
                        
                        if(gotLife == true)//only if we havent been given the life already then give it and restrict permission for another
                        {
                            lives += 1;
                            gotLife = false;            //make permission for another life false
                            lifeDotLocationSet = false; //show the location of the dot has not been set
                        }                
                    }
                }
                
                //Everytime function is ran 7times we set to zero. every 6 times we change pacmans mouth.
                if(changeMouth == 7)
                {
                    changeMouth = 0;
                }
                
               //change mouth functions are defined in MouthMovePacman.js you can see changeMouth is passed as a parameter
               mouthPositions = changeMouthRight(changeMouth, openCloseMouth1, openCloseMouth2);
               openCloseMouth1 = mouthPositions[0];
               openCloseMouth2 = mouthPositions[1];  
               
               //if pacman hasnt been caught we just draw him as normal
               if(caught == false)
               {
                    //Pacman only goes right while X is less than border X, function defined in BorderCollisionsPacman.js
                    leftRight = rightBorderCollision(leftRight, upAndDownbody, radius, canvas.width, openCloseMouth1, openCloseMouth2, ctx,                                                     "yellow");
               }
               else if(caught == true)//but if he has been caught
               {
                   //increment counter and perform modulus % 2 operation to get either 0 or 1
                   stillHitCnt += 1;
                   changePacmanColour = stillHitCnt % 2;
                   
                   if(changePacmanColour == 0)//Then make pacman flicker red/yellow every second frame
                   {
                       leftRight = rightBorderCollision(leftRight, upAndDownbody, radius, canvas.width, openCloseMouth1, openCloseMouth2, ctx,                                                     "yellow");
                   }
                   else if(changePacmanColour == 1)
                   {
                       leftRight = rightBorderCollision(leftRight, upAndDownbody, radius, canvas.width, openCloseMouth1, openCloseMouth2, ctx,                                                     "red");
                   }
               }
                
               //Using the Dot classes intersect function to determine if pacman has caught the dot and if so 
               if(dot.intersect(leftRight, upAndDownbody, radius))
               {
                   gotDotAudio(pacmanEatsAudio); //play the got dot audio, pass in the audio object
                   
                   //Set a new x/y co-ordinate for it and move it. Dot will be redrawn at start of function next frame
                   xRandomDot = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;     
                   yRandomDot = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
                   dot.moveDot(xRandomDot, yRandomDot);
                   
                   //Check if ball speed has hit its maximum and if so
                   if(ballSpeedX >= ballMaxSpeed || ballSpeedX <= -ballMaxSpeed || ballSpeedY >= ballMaxSpeed || ballSpeedY <= -ballMaxSpeed)
                   {
                       //dont do anything, speed remains unchanged
                       ballSpeedX = ballSpeedX;
                       ballSpeedY = ballSpeedY;
                   }
                   else
                   {
                       //Otherwise increase the speed of the ball (defined in GameplayFunctions.js)
                       speeds = increaseBallSpeed(ballSpeedX, ballSpeedY);//defined above
                       ballSpeedX = speeds[0];
                       ballSpeedY = speeds[1];
                   }
                   
                   scoreCnt += scoreIncrease; //Increment the score by amount of score increase
                   scoreIncrease += 2; //increase score increase
                   
                   //If we have gotten 5 dots in a row
                   if((scoreCnt % 5 == 0) && (scoreCnt != 0))
                   {
                       gotLife = true;//we are allowed an extra life
                   }
                   
               }
                
               //Making sure the ball chasing pacman bounces around the canvas (collision detection for canvas border and bouncing ball)
               //defined in BouncingBall.js
               directions = bounceBall.makeBallBounce(canvas.width, canvas.height, ballSpeedX, ballSpeedY);
               ballSpeedX = directions[0];
               ballSpeedY = directions[1];
                
               //Using bounceBalls intersect function, if pacman collides with the bouncing ball. (defined in BouncingBall.js)
               if(bounceBall.intersect(leftRight, upAndDownbody, radius))
               {
                   //Play pacman hurt audio which is done by the function here, pass in the audio
                   pacmanInjuredAudio(pacmanHurtAudio);
                   
                   //Makes sure that when pacman is hit, he is only hit once
                   //only if his lives are 0 and he hasnt been caught previously
                   if(lives == 0 && caught == false)
                   {
                       pacmanDeadEndAudio = true; //set end audio to true because game is over
                       play = false;//we are dead so set play to false. Stops frames running in background behind the popup
                       
                       //call the startGameplayAudio() function to switch off audio. pacmanDeadEndAudio = true
                       pacmanAudioResults = startGameplayAudio(pacmanAudioOn, pacmanDeadEndAudio, pacmanAudio);
                       pacmanAudioOn = pacmanAudioResults[0];
                       pacmanDeadEndAudio = pacmanAudioResults[1];
                       
                       //call pacmanDeadAudio() and pass the audio to the function where it will be played
                       pacmanDeadAudio(pacmanDiesAudio);
                       
                       //Alert you have died, give the score also, uses jQuery plugin for custom confirm box (defined in Gameplayfunctions.js)
                       outputGameOverPopup(scoreCnt);
                   }
                   else if(caught == false)//else if he still has lives and hasnt been already hit
                   {
                        lives -= 1;        //take lives away
                        caught = true;     //caught = true. Wont keep losing lives while their pixels intersect.(allows ball to pass through)
                   }
               }
               else//otherwise he hasnt been hit so its false
               { 
                   caught = false;
               }
                
               xRandomBall += ballSpeedX;       //increment bouncing balls x/y and changemouth counter
               yRandomBall += ballSpeedY 
               changeMouth += 1;
            
            //request animation frame for this function and pass the animation id to var stopRight
            stopRight = window.requestAnimationFrame(pacmanGoRight);
            }
        }
        
        //Make pacman go left
        function pacmanGoLeft()
        {
            //Only if play is true do we run the animation frame
            if(play == true)
            {
                //Redraw canvas background (defined in GameplayFunctions.js)
                redrawCanvasBackground(ctx, canvas.height, canvas.width);
            
                //output the score and lives of user (defined in GameplayFunctions.js)
                outputUserInfo(ctx, scoreCnt, lives);
            
                dot.drawDot();//Draw random dot (defined in Dot.js)
                 
                //Move x/y of bouncing ball and then draw it (Defined in BouncingBall.js)
                bounceBall.moveBall(xRandomBall, yRandomBall);
                bounceBall.drawBall();
   
                //If we are allowed an extra life we set and draw the extra life dot dot/check for collisions on it
                if(gotLife == true)
                {
                    //move and draw the extra life dot, only draws if we are entitled to a life
                    //Set a new x/y co-ordinate for it and move it.
                    //If we are allowed an extra life we set and draw the extra life dot dot/check for collisions on it
                    if(lifeDotLocationSet == false)
                    {
                        lifeDotX = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;     
                        lifeDotY = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
                        dotExtraLife.moveDot(lifeDotX, lifeDotY) //(defined in Dot.js)
                        lifeDotLocationSet = true;
                    }
                    dotExtraLife.drawDot();
                    
                    //If they intersect give an extra life (defined in Dot.js)
                    if(dotExtraLife.intersect(leftRight, upAndDownbody, radius))
                    {
                        gotDotAudio(pacmanEatsAudio); //play the got dot audio, pass in the audio object
                        
                        if(gotLife == true)//only if we havent been given the life already then give it and restrict permission for another
                        {
                            lives += 1;
                            gotLife = false;                //make permission for another life false
                            lifeDotLocationSet = false;     //show the location has not been set
                        }                
                    }
                }
            
                //Everytime function is ran 7times we set to zero. every 6 times we change pacmans mouth.
                if(changeMouth == 7)
                {
                    changeMouth = 0;
                }
                
                //change mouth functions are defined in MouthMovePacman.js
                mouthPositions = changeMouthLeft(changeMouth, openCloseMouth3, openCloseMouth4);
                openCloseMouth3 = mouthPositions[0];
                openCloseMouth4 = mouthPositions[1];  
                
                //if pacman hasnt been caught we just draw him as normal
                if(caught == false)
                {
                    //Pacman only goes left while X is greater than border X, function defined in BorderCollisionsPacman.js 
                    leftRight = leftBorderCollision(leftRight, upAndDownbody, radius, canvas.width, openCloseMouth3, openCloseMouth4, ctx,                                                          "yellow");
                }
                else if(caught == true)//but if he has been caught
                {
                    //following two lines will increment counter and perform % 2 on it to return either 0 or 1
                   stillHitCnt += 1;
                   changePacmanColour = stillHitCnt % 2;
                   
                   //make pacman flicker every second frame
                   if(changePacmanColour == 0)
                   {
                       leftRight = leftBorderCollision(leftRight, upAndDownbody, radius, canvas.width, openCloseMouth3, openCloseMouth4, ctx,                                                     "yellow");
                   }
                   else if(changePacmanColour == 1)
                   {
                       leftRight = leftBorderCollision(leftRight, upAndDownbody, radius, canvas.width, openCloseMouth3, openCloseMouth4, ctx,                                                     "red");
                   }
                }
                
                //Using the Dot classes intersect function to determine if pacman has caught the dot and if so (defined in Dot.js)
                if(dot.intersect(leftRight, upAndDownbody, radius))
                {
                   gotDotAudio(pacmanEatsAudio); //play the got dot audio, pass in the audio object  
                    
                   //Set a new x/y co-ordinate for it and move it. Dot will be redrawn at start of function
                   xRandomDot = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;     
                   yRandomDot = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
                   dot.moveDot(xRandomDot, yRandomDot);
                   
                   //Check if ball speed has hit its maximum and if so    
                   if(ballSpeedX == ballMaxSpeed || ballSpeedX == -ballMaxSpeed || ballSpeedY == ballMaxSpeed || ballSpeedY == -ballMaxSpeed)
                   {
                       //dont do anything, speed remains unchanged
                       ballSpeedX = ballSpeedX;
                       ballSpeedY = ballSpeedY;
                   }
                   else
                   {
                       //Otherwise increase the speed of the ball (defined in GameplayFunctions.js)
                       speeds = increaseBallSpeed(ballSpeedX, ballSpeedY);
                       ballSpeedX = speeds[0];
                       ballSpeedY = speeds[1];
                   }
            
                   scoreCnt += scoreIncrease; //Increment the score by amount of score increase
                   scoreIncrease += 2; //increase score increase
                    
                   //If we have gotten 5 dots in a row    
                   if((scoreCnt % 5 == 0) && (scoreCnt != 0))
                   {
                       gotLife = true;//we are allowed an extra life
                   }
                }
                
                //Making sure the ball chasing pacman bounces around the canvas (collision detection for canvas border and bouncing ball)
                //defined in BouncingBall.js
                directions = bounceBall.makeBallBounce(canvas.width, canvas.height, ballSpeedX, ballSpeedY);
                ballSpeedX = directions[0];
                ballSpeedY = directions[1];
                
                //Using bounceBalls intersect function, if pacman collides with the bouncing ball.
                //this function will keep calling while they are intersected.
                //(defined in BouncingBall.js)
                if(bounceBall.intersect(leftRight, upAndDownbody, radius))
                {
                    //Play pacman hurt audio which is done by the fucntion here, pass in the audio
                    pacmanInjuredAudio(pacmanHurtAudio);
                    
                    //Makes sure that when pacman is hit, he is only hit once
                    //only if his lives are 0 and he hasnt been caught previously
                    if(lives == 0 && caught == false)
                    {
                       pacmanDeadEndAudio = true; //set end audio to true because game is over
                       play = false;//we are dead so set play to false. Stops frames running in background behind the popup
                        
                       //call the startGameplayAudio() function to switch off audio. pacmanDeadEndAudio = true    
                       pacmanAudioResults = startGameplayAudio(pacmanAudioOn, pacmanDeadEndAudio, pacmanAudio);
                       pacmanAudioOn = pacmanAudioResults[0];
                       pacmanDeadEndAudio = pacmanAudioResults[1];
                        
                       //call pacmanDeadAudio() and pass the audio to the function where it will be played
                       pacmanDeadAudio(pacmanDiesAudio);
                       
                       //Alert you have died, give the score also, uses jQuery plugin for custom confirm box (defined in Gameplayfunctions.js)
                       outputGameOverPopup(scoreCnt);
                    }
                    else if(caught == false)//else if he is caught but still has lifes
                    {
                        lives -= 1;    //take away life
                        caught = true; //caught = true. Wont keep losing lives while their pixels intersect.(allows ball to pass through)
                    }          
                }
                else //only when pacman/ball have both seperated that caught is set back to false
                {
                   caught = false;
                }
            
                xRandomBall += ballSpeedX;        //increment bouncing balls x/y and changemouth counter
                yRandomBall += ballSpeedY; 
                changeMouth += 1;
            
            //request animation frame for this function and pass the animation id to var stopLeft
            stopLeft = window.requestAnimationFrame(pacmanGoLeft);
            }
        }
        
        //Make pacman go up
       function pacmanGoUp()
       {
           //Only if play is true do we run the animation frame
           if(play == true)
           {
                //Redraw canvas background (defined in GameplayFunctions.js)
                redrawCanvasBackground(ctx, canvas.height, canvas.width);
           
                outputUserInfo(ctx, scoreCnt, lives); //(defined in GameplayFunctions.js)
           
                dot.drawDot();//Draw random dot (Defined in Dot.js)
                
                //Move x/y of bouncing ball and then draw it (Defined in BouncingBall.js)
                bounceBall.moveBall(xRandomBall, yRandomBall);
                bounceBall.drawBall();
           
                //If we are allowed an extra life
                if(gotLife == true)
                {
                    //move and draw the extra life dot, only draws if we are entitled to a life
                    //Set a new x/y co-ordinate for it and move it. (only if the location has not already been set)
                    if(lifeDotLocationSet == false)
                    {
                        //create random x,y position
                        lifeDotX = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;     
                        lifeDotY = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
                        dotExtraLife.moveDot(lifeDotX, lifeDotY)//move the dot function (Defined in Dot.js)
                        lifeDotLocationSet = true;
                    }
                    dotExtraLife.drawDot();
                    
                    //If they intersect give an extra life (Defined in Dot.js)
                    if(dotExtraLife.intersect(leftRight, upAndDownbody, radius))
                    {
                        gotDotAudio(pacmanEatsAudio); //play the got dot audio, pass in the audio object
                        
                        if(gotLife == true)//only if we havent been given the life already then give it and restrict permission for another
                        {
                            lives += 1;
                            gotLife = false;
                            lifeDotLocationSet = false;
                        }                
                    }
                }
                
                //Everytime function is ran 7times we set to zero. every 6 times we change pacmans mouth.
                if(changeMouth == 7)
                {
                    changeMouth = 0;
                }
                
                //change mouth functions are defined in MouthMovePacman.js
                mouthPositions = changeMouthUp(changeMouth, openCloseMouth5, openCloseMouth6);
                openCloseMouth5 = mouthPositions[0];
                openCloseMouth6 = mouthPositions[1];  
                
                //if pacman hasnt been caught we just draw him as normal
                if(caught == false)
                {
                    //Pacman only goes up while Y is greater than border Y, function defined in BorderCollisionsPacman.js
                    upAndDownbody = upBorderCollision(leftRight, upAndDownbody, radius, canvas.height, openCloseMouth5, openCloseMouth6, ctx,                                                      "yellow");
                }
                else if(caught == true)//but if he has been caught
                {
                    //following two lines will increment counter and perform % 2 on it to return either 0 or 1
                   stillHitCnt += 1;
                   changePacmanColour = stillHitCnt % 2;
                   
                    //makes pacman flicker red/yellow every second frame
                   if(changePacmanColour == 0)
                   {
                       upAndDownbody = upBorderCollision(leftRight, upAndDownbody, radius, canvas.height, openCloseMouth5, openCloseMouth6,                                                              ctx, "yellow");
                   }
                   else if(changePacmanColour == 1)
                   {
                       upAndDownbody = upBorderCollision(leftRight, upAndDownbody, radius, canvas.height, openCloseMouth5, openCloseMouth6,                                                              ctx, "red");
                   }
                }
                
                //Using the Dot classes intersect function to determine if pacman has caught the dot and if so 
                //(Defined in Dot.js)
                if(dot.intersect(leftRight, upAndDownbody, radius))
                {
                   gotDotAudio(pacmanEatsAudio); //play the got dot audio, pass in the audio object
                    
                   //Set a new x/y co-ordinate for it and move it. Dot will be redrawn at start of function
                   xRandomDot = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;     
                   yRandomDot = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
                   dot.moveDot(xRandomDot, yRandomDot);
                
                   //Check if ball speed has hit its maximum and if so    
                   if(ballSpeedX == ballMaxSpeed || ballSpeedX == -ballMaxSpeed || ballSpeedY == ballMaxSpeed || ballSpeedY == -ballMaxSpeed)
                   {
                       //dont do anything, speed remains unchanged
                       ballSpeedX = ballSpeedX;
                       ballSpeedY = ballSpeedY;
                   }
                   else
                   {
                       //Otherwise increase the speed of the ball (defined in GameplayFunctions.js)
                       speeds = increaseBallSpeed(ballSpeedX, ballSpeedY);
                       ballSpeedX = speeds[0];
                       ballSpeedY = speeds[1];
                   }
                    
                   scoreCnt += scoreIncrease; //Increment the score by amount of score increase
                   scoreIncrease += 2; //increase score increase
                
                   //if we got 5 straight dots we are allowed an extra life
                   if((scoreCnt % 5 == 0) && (scoreCnt != 0))
                   {
                       gotLife = true;
                   }
                    
                }
               
                //Making sure the ball chasing pacman bounces around the canvas (collision detection for canvas border and bouncing ball)
                //defined in BouncingBall.js
                directions = bounceBall.makeBallBounce(canvas.width, canvas.height, ballSpeedX, ballSpeedY);
                ballSpeedX = directions[0];
                ballSpeedY = directions[1];
                
                //Using bounceBalls intersect function, if pacman collides with the bouncing ball.
                //(Defined in BouncingBall.js)
                if(bounceBall.intersect(leftRight, upAndDownbody, radius))
                {
                    //Play pacman hurt audio which is done by the fucntion here, pass in the audio
                    pacmanInjuredAudio(pacmanHurtAudio);
                    
                    if(lives == 0 && caught == false)
                    {
                       pacmanDeadEndAudio = true; //set end audio to true because game is over
                       play = false;//we are dead so set play to false. Stops frames running in background behind the popup
                       
                       //call the startGameplayAudio() function to switch off audio. pacmanDeadEndAudio = true
                       pacmanAudioResults = startGameplayAudio(pacmanAudioOn, pacmanDeadEndAudio, pacmanAudio);
                       pacmanAudioOn = pacmanAudioResults[0];
                       pacmanDeadEndAudio = pacmanAudioResults[1];
                       
                       //call pacmanDeadAudio() and pass the audio to the function where it will be played
                       pacmanDeadAudio(pacmanDiesAudio);    
                        
                       //Alert you have died, give the score also, uses jQuery plugin for custom confirm box (defined in Gameplayfunctions.js)
                       outputGameOverPopup(scoreCnt);                                 
                    }
                    else if(caught == false)
                    {
                        lives -= 1;       //take life away
                        caught = true;    //caught = true. Wont keep losing lives while their pixels intersect.(allows ball to pass through)
                    }   
                }
                else//only when pacman/ball have both seperated that caught is set back to false
                { 
                    caught = false;
                }
            
                xRandomBall += ballSpeedX;            //increment bouncing balls x/y and changemouth counter
                yRandomBall += ballSpeedY;
                changeMouth += 1;
           
           //request animation frame for this function and pass the animation id to var stopUp
           stopUp = window.requestAnimationFrame(pacmanGoUp);
        }
    }
    
    //Make pacman go down
    function pacmanGoDown()
    {
        //Only if play is true do we run the animation frame
        if(play == true)
        {
            //Redraw canvas background (defined in GameplayFunctions.js)
            redrawCanvasBackground(ctx, canvas.height, canvas.width);
        
            //Output score and lives (Defined in GameplayFunctions.js)
            outputUserInfo(ctx, scoreCnt, lives);
        
            dot.drawDot();//Draw random dot (Defined in Dot.js)
            
            //Move x/y of bouncing ball and then draw it (Defined in BouncingBall.js)
            bounceBall.moveBall(xRandomBall, yRandomBall);
            bounceBall.drawBall();
        
            //If we are allowed an extra life
            if(gotLife == true)
            {
                //move and draw the extra life dot, only draws if we are entitled to a life
                //Set a new x/y co-ordinate for it and move it.
                if(lifeDotLocationSet == false)
                {
                    lifeDotX = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;     
                    lifeDotY = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
                    dotExtraLife.moveDot(lifeDotX, lifeDotY) //(Defined in Dot.js)
                    lifeDotLocationSet = true;
                }
                dotExtraLife.drawDot();
                    
                //If they intersect give an extra life (Defined in Dot.js)
                if(dotExtraLife.intersect(leftRight, upAndDownbody, radius))
                {
                    gotDotAudio(pacmanEatsAudio);
                    
                    if(gotLife == true)//only if we havent been given the life already then give it and restrict permission for another
                    {
                        lives += 1;
                        gotLife = false;
                        lifeDotLocationSet = false;
                    }                
                }
            }
    
            //Everytime function is ran 7times we set to zero. every 6times we change pacmans mouth.
            if(changeMouth == 7)
            {
                changeMouth = 0;
            }
        
            //change mouth functions are defined in MouthMovePacman.js
            mouthPositions = changeMouthDown(changeMouth, openCloseMouth7, openCloseMouth8);
            openCloseMouth7 = mouthPositions[0];
            openCloseMouth8 = mouthPositions[1]; 
            
            //if pacman hasnt been caught just draw him as normal
            if(caught == false)
            {
                //Pacman only goes down while Y is less than border Y, function defined in BorderCollisionsPacman.js
                upAndDownbody = downBorderCollision(leftRight, upAndDownbody, radius, canvas.height, openCloseMouth7, openCloseMouth8, ctx,                                                        "yellow"); 
            }
            else if(caught == true)//but if he has been caught
            {
                //increment counter and perform modulus operation to get either 0 or 1
                stillHitCnt += 1;
                changePacmanColour = stillHitCnt % 2;
                   
                //make pacman flicker yellow/red every second frame
                if(changePacmanColour == 0)
                {
                    upAndDownbody = downBorderCollision(leftRight, upAndDownbody, radius, canvas.height, openCloseMouth7, openCloseMouth8,                                                              ctx, "yellow");
                }
                else if(changePacmanColour == 1)
                {
                    upAndDownbody = downBorderCollision(leftRight, upAndDownbody, radius, canvas.height, openCloseMouth7, openCloseMouth8,                                                              ctx, "red");
                }
            }
                
            
            //Using the Dot classes intersect function to determine if pacman has caught the dot and if so 
            if(dot.intersect(leftRight, upAndDownbody, radius))
            {
                gotDotAudio(pacmanEatsAudio); //play got dot audio, pass in audio object
                
                //Set a new x/y co-ordinate for it and move it. Dot will be redrawn at start of function
                xRandomDot = Math.floor((Math.random() * (canvas.width - (dotRadius * 2)))) + dotRadius;     
                yRandomDot = Math.floor((Math.random() * (canvas.height - (dotRadius * 2)))) + dotRadius; 
                dot.moveDot(xRandomDot, yRandomDot);
                
                //Check if ball speed has hit its maximum and if so
                if(ballSpeedX == ballMaxSpeed || ballSpeedX == -ballMaxSpeed || ballSpeedY == ballMaxSpeed || ballSpeedY == -ballMaxSpeed)
                {
                    //dont do anything, speed remains unchanged
                    ballSpeedX = ballSpeedX;
                    ballSpeedY = ballSpeedY;
                }
                else
                {
                    //Otherwise increase the speed of the ball (defined in GameplayFunctions.js)
                    speeds = increaseBallSpeed(ballSpeedX, ballSpeedY);
                    ballSpeedX = speeds[0];
                    ballSpeedY = speeds[1];
                }
            
                scoreCnt += scoreIncrease; //Increment the score by amount of score increase
                scoreIncrease += 2; //increase score increase
                
                //if we have gotten 5 straight dots we are entitled to an extra life.
                if((scoreCnt % 5 == 0) && (scoreCnt != 0))
                {
                    gotLife = true;
                }
            }
            
            //Making sure the ball chasing pacman bounces around the canvas (collision detection for canvas border and bouncing ball)
            //defined in BouncingBall.js
            directions = bounceBall.makeBallBounce(canvas.width, canvas.height, ballSpeedX, ballSpeedY);
            ballSpeedX = directions[0];
            ballSpeedY = directions[1];
            
            //Using bounceBalls intersect function, if pacman collides with the bouncing ball.
            //(Defined in BouncingBall.js)
            if(bounceBall.intersect(leftRight, upAndDownbody, radius))
            {
                //Play pacman hurt audio which is done by the fucntion here, pass in the audio
                pacmanInjuredAudio(pacmanHurtAudio);
                
                if(lives == 0 && caught == false)
                {
                   pacmanDeadEndAudio = true; //set end audio to true because game is over
                   play = false; //we are dead so set play to false. Stops frames running in background behind the popup
                
                   //call the startGameplayAudio() function to switch off audio. pacmanDeadEndAudio = true
                   pacmanAudioResults = startGameplayAudio(pacmanAudioOn, pacmanDeadEndAudio, pacmanAudio);
                   pacmanAudioOn = pacmanAudioResults[0];
                   pacmanDeadEndAudio = pacmanAudioResults[1];
                    
                   //call pacmanDeadAudio() and pass the audio to the function where it will be played
                   pacmanDeadAudio(pacmanDiesAudio);
                       
                   //Alert you have died, give the score also, uses jQuery plugin for custom confirm box (defined in Gameplayfunctions.js)
                   outputGameOverPopup(scoreCnt);
                }
                else if(caught == false)//if pacman has lives but has been caught
                {
                    lives -= 1;     //take life away
                    caught = true;  //caught = true. Wont keep losing lives while their pixels intersect.(allows ball to pass through)
                }   
            }
            else//only when pacman/ball have both seperated that caught is set back to false
            {
                caught = false;
            }
            
            xRandomBall += ballSpeedX;                          //increment bouncing balls x/y and changemouth counter
            yRandomBall += ballSpeedY;  
            changeMouth += 1;
        
        //request animation frame for this function and pass the animation id to var stopDown
        stopDown = window.requestAnimationFrame(pacmanGoDown);
        }
    }
    </script>
  </body>
</html>